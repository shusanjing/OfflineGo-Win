# OfflineGo - 断网守卫

`OfflineGo` 是一款专为 **无通讯功能的 UPS 供电 PC** 设计。它通过持续监控网络状态，在检测到电力中断（通常表现为网关网络断开）时，自动执行安全保护操作（如系统休眠、关机或自定义脚本），有效避免因电池耗尽导致的非法关机与数据损坏。



## 🛠 核心功能逻辑

### 1. 智能网络监控
* **状态心跳检测**：程序采用 ICMP (Ping) 协议，根据设定的 `PingInterval` 定期轮询目标 IP（如网关或不间断供电的路由器）。
* **多重容错机制**：为防止单次网络波动导致误报警，程序引入了 `RetryCount` 判定。只有当连续失败次数达到阈值后，才会被判定为“确认断网”。
* **并发安全设计**：使用 `sync.RWMutex` 确保配置参数在 GUI 修改与后台监控协程之间的同步安全。

### 2. 自动化响应与倒计时
* **缓冲预警**：一旦确认断网，程序会强制显示并置顶窗口，启动 `WaitDuration` 倒计时。这为用户提供了手动拦截的机会（例如仅是临时的网络维护）。
* **静默命令执行**：倒计时结束后，程序调用 Windows 的 `cmd.exe` 执行预设命令。通过底层 API 实现，**完全隐藏执行过程中的黑色控制台窗口**。
* **状态自愈**：若在倒计时期间网络恢复，程序会自动取消执行计划，停止倒计时。

### 3. 系统交互与持久化
* **系统托盘化**：支持最小化至托盘运行，利用 `walk.NotifyIcon` 实现后台静默守护。
* **实时日志系统**：程序在 `log/` 目录下按日期生成日志文件，详细记录启动、配置变更、网络异常及命令执行结果。
* **动态配置加载**：基于 INI 格式实现配置持久化。用户既可以通过 GUI 界面修改，也可以直接编辑带有详细注释的 `config.ini`。

---

## 💻 技术栈

| 模块 | 技术实现 |
| :--- | :--- |
| **开发语言** | Go (Golang) |
| **GUI 框架** | `lxn/walk` (Windows 原生 API 封装) |
| **网络探测** | `go-ping/ping` (ICMP 协议实现) |
| **底层交互** | `win` & `syscall` (用于窗口置顶、托盘交互及进程隐藏) |
| **配置管理** | `gopkg.in/ini.v1` |

---

## ⚙ 常用配置项说明

```ini
[Network]
TargetIP     = 192.168.123.1 ; 监控的目标 IP（如网关）
PingInterval = 5             ; 每 5 秒检测一次
RetryCount   = 3             ; 连续失败 3 次确认断网


[Actions]
WaitDuration = 180           ; 断网确认后倒计时 180 秒执行
ActionCommand = shutdown /h  ; 执行的命令（默认休眠）
AutoHideOnSuccess = true     ; 网络恢复后是否自动隐藏窗口
```

---

**建议操作：**
由于该程序涉及到 **ICMP (Ping)** 和 **系统关机命令**，通常需要管理员权限才能正常工作。
